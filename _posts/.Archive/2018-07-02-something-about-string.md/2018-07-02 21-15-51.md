---
title: ä»ä¸€æ¡æ²¡æœ‰è¢«é‡Šæ”¾çš„å­—ç¬¦ä¸²è¯´èµ·
comments: true
---

### èµ·å› 
è¿™ç¯‡æ–‡ç« çš„èµ·å› æºè‡ªä¸€æ®µiOSä»£ç ï¼Œæ˜¯ä¸€ä½æ±‚èŒè€…åœ¨é¢è¯•æ—¶ï¼Œè®²è¿°ä»–å‘ç°çš„ç°è±¡ï¼Œå¹¶é¢‡å¼•ä»¥ä¸ºå‚²ã€‚å°±æ˜¯åœ¨å¯¹è±¡å’Œå­—ç¬¦ä¸²åœ¨é‡Šæ”¾æ—¶çš„å·®å¼‚ï¼ŒNSObjectå¯¹è±¡p1åœ¨ç½®ç©ºåï¼Œå¼±å¼•ç”¨å®ƒçš„å˜é‡weakP1æ‰€æŒ‡å‘çš„å†…å®¹ä¹Ÿè¢«ç½®ç©ºï¼Œå³è¿™å—å†…å­˜ç©ºé—´è¢«é‡Šæ”¾äº†ã€‚è€ŒStringå¯¹è±¡ç”¨åŒæ ·çš„æ“ä½œï¼Œå¼±å¼•ç”¨çš„weakStræ‰€æŒ‡å‘çš„ç©ºé—´æ²¡æœ‰

````objc
NSObject *p = [[NSObject alloc]init];
__weak NSObject *weakP = p;
p = nil;
NSLog(@"p %@, weakP %@",p,weakP);

NSString *str = [NSString stringWithFormat:@"%@",@"hello world!"];
__weak NSString *weakStr = str;
str = nil;
NSLog(@"str %@, weakStr %@",str,weakStr);
````

### æ ˆ(Stack)å’Œå †(Heap)
ä¸ºä»€ä¹ˆå †æ ˆæ€»æ˜¯è¢«åŒæ—¶æåŠï¼Œè€Œåˆå‚»å‚»åˆ†ä¸æ¸…æ¥šï¼Ÿåœ¨ä¸€èˆ¬çš„ä¸­è‹±è¯å…¸ä¸­Stack(n. å †ï¼›å †å )å’ŒHeap(n. å †ï¼›è®¸å¤šï¼›ç´¯ç§¯)ï¼Œéƒ½è¢«ç¿»è¯‘æˆå †ï¼Œå¹¶æ²¡æœ‰å‡ºç°æ ˆè¿™ä¸ªè¯ã€‚è€Œæ ˆåœ¨ä¸­æ–‡è¯å…¸é‡Œæ˜¯â€œå‚¨å­˜è´§ç‰©æˆ–ä¾›æ—…å®¢ä½å®¿çš„æˆ¿å±‹â€çš„æ„æ€ã€‚æ‰€ä»¥æ¨æµ‹è¯‘è€…æ˜¯ä¸ºäº†åœ¨ä¸­æ–‡é‡ŒåŒºåˆ†è¿™ä¸¤ä¸ªâ€œå †â€è€Œç‰¹æ„æ‰¾çš„ç›¸è¿‘çš„è¯â€”â€”â€œæ ˆâ€ã€‚

é‚£ä¹ˆåœ¨è‹±æ–‡é‡ŒStackå’ŒHeapæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿåœ¨æœ—æ–‡è‹±è¯­è¯å…¸ä¸­ï¼ŒStackæ„æ€æ˜¯`a neat pile of things `ï¼Œå®ƒæŒ‡å‘äº†ä¸€ä¸ªè¿‘ä¹‰è¯Heapï¼Œæ„æ€æ˜¯`a large untidy pile of things`ã€‚åŒºåˆ«åœ¨äºStackæ˜¯æ•´é½åœ°å †å ï¼ŒHeapæ˜¯ä¸€å¤§ç‰©å“çš„å †ç§¯ã€‚å…¶å®åœ¨ä¸­æ–‡ç¿»è¯‘ä¸­å·²ç»æœ‰æ‰€ä½“ç°ï¼Œåªæ˜¯å®¹æ˜“è®©äººå¿½è§†ï¼Œå³â€œå â€å’Œâ€œç§¯â€çš„å·®å¼‚ã€‚é—ªè€€ç€ä»¤äººæƒŠå–œçš„è¯­è¨€æ™ºæ…§ã€‚

åœ¨è®¡ç®—æœºé¢†åŸŸï¼Œæ•°æ®ç»“æ„å’Œå†…å­˜æ¦‚å¿µä¸­éƒ½å‡ºç°äº†Heapè¿™ä¸ªè¯ï¼Œä¹Ÿå¾ˆå®¹æ˜“æ··æ·†ã€‚æœ€åˆHeapæ˜¯è¡¨ç¤ºçš„ä¸€ç§æ ‘å‹çš„æ•°æ®ç»“æ„ï¼Œæ ¹æ®æ ¹èŠ‚ç‚¹å¤§äºè¿˜æ˜¯å°äºå­èŠ‚ç‚¹ï¼Œåˆ†ä¸ºæœ€å¤§å †å’Œæœ€å°å †ã€‚

æ›´å¤šçš„æƒ…å†µä¸‹ï¼Œå½“æˆ‘ä»¬è¯´å †æ ˆæ—¶ï¼Œè¯´çš„æ˜¯ä¸€ç§å†…å­˜çš„åˆ†é…æ–¹å¼ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ

![ ]( /assets/img/2018/9c2VH.png )
> Stacks in computing architectures are regions of memory where data is added or removed in a last-in-first-out  manner.

>   Heap  is a common name for the pool of memory from which dynamically allocated memory is allocated.

Wikiä¹Ÿè§£é‡Šçš„æ¯”è¾ƒæ¸…æ¥šã€‚Stackçš„å†…å­˜åˆ†é…é€»è¾‘æ¯”è¾ƒæ¸…æ¥šï¼Œå…ˆè¿›åå‡ºã€‚Heapåˆ†é…æ–¹å¼å°±æ¯”è¾ƒçµæ´»ï¼Œè‡³äºå†…å­˜çš„ç®¡ç†ï¼Œå› è¯­è¨€å’Œç³»ç»Ÿä¸åŒä¼šå­˜åœ¨å·®å¼‚ï¼Œè¿™é‡Œå…ˆä¸å±•å¼€äº†ã€‚

### å †æ ˆå­˜åœ¨çš„ç†ç”±
å †æ ˆä»æœ¬è´¨ä¸Šè®²æ˜¯æä¾›ç¨‹åºè¿è¡Œæ‰€éœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œä½†ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸¤ç§å½¢å¼ï¼Ÿå› ä¸ºç¨‹åºä¸ä»…ä»…æ˜¯ç”±æ•°æ®æ„æˆï¼Œè¿˜åŒ…æ‹¬å¤„ç†æ•°æ®çš„é€»è¾‘æ–¹æ³•ã€‚è€Œè¿™äº›æ–¹æ³•çš„ç¼–ç å’Œæ‰§è¡Œé¡ºåºæ˜¯éå¸¸ç¬¦åˆåå‡ºå…ˆè¿›çš„è®¾è®¡é€»è¾‘ã€‚å› æ­¤æ ˆçš„å­˜åœ¨æ›´å¤šæ˜¯ä¸ºç¨‹åºçš„æ–¹æ³•æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»å¸¸è¯´çš„è°ƒç”¨æ ˆå°±æ˜¯æŒ‡å¯ä»¥æŸ¥çœ‹ç¨‹åºè°ƒç”¨é¡ºåºçš„å†…å­˜ç©ºé—´ï¼Œåœ¨æ ˆé¡¶éƒ¨çš„å°±æ˜¯æœ€åæ‰§è¡Œçš„æ–¹æ³•ã€‚æ–¹æ³•ä¸­çš„ä¸´æ—¶å˜é‡å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¹Ÿä¼šå­˜åœ¨æ ˆä¸­ã€‚ç†è®ºä¸Šè¿™äº›å˜é‡å…¨éƒ¨åœ¨å †(Heap)ä¸­ç”Ÿæˆä¹Ÿæ˜¯å¯è¡Œçš„ã€‚
![ ]( /assets/img/2018/i6k0Z.png )

ä½†æ˜¯åœ¨æ ˆä¸­å­˜å‚¨æœ‰ä¸¤ä¸ªä¼˜åŠ¿ï¼Œä¸€ä¸ªæ˜¯ç”±äºæ ˆçš„ç‰¹æ€§ï¼Œæ ˆä¸­çš„æ–¹æ³•æ‰§è¡Œå®Œåï¼Œä¼šå®æ—¶ä»æ ˆé¡¶ç§»é™¤ã€‚æ ˆä¸­çš„ä¸´æ—¶å˜é‡çš„å£°æ˜å‘¨æœŸä¹Ÿå› æ­¤ç»“æŸï¼Œå†…å­˜é‡Šæ”¾æ•ˆç‡éå¸¸é«˜ã€‚å¦ä¸€æ–¹é¢ï¼Œæ ˆçš„å¤§å°é€šå¸¸æ˜¯å›ºå®šçš„ï¼Œåœ¨æˆ‘çš„MacBookä¸Šé€šè¿‡`ulimit -s`æŸ¥çœ‹æ˜¯8MBã€‚ç›¸è¾ƒ8GBçš„å†…å­˜ï¼Œä¸ºä½•æ ˆå¤§å°åªæœ‰åŒºåŒº8MBã€‚å…¶ä¸­çš„ä¸€ç§è¯´æ³•æ˜¯ï¼Œæ ˆçš„è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯ç¨‹åºæ‰§è¡Œçš„é€Ÿåº¦ï¼Œä¸ä»…ä»…ä¾èµ–äºCPUï¼Œä¹ŸåŒæ ·ä¾èµ–å†…å­˜çš„è¯»å–é€Ÿåº¦ã€‚æ‰€ä»¥æ ˆçš„å­˜å‚¨ä¼šä¾èµ–äºå¤§å°æœ‰é™çš„é«˜é€Ÿç¼“å­˜ï¼Œå¦‚æœæ ˆè¿‡å¤§ï¼Œåˆ™é«˜é€Ÿç¼“å­˜ä¼šå‡ºç°å¤§é‡å†…å­˜ç©ºé—´çš„äº¤æ¢ï¼Œåè€Œé™ä½äº†æ‰§è¡Œçš„é€Ÿåº¦ã€‚è€Œçè´µæœ‰é™çš„æ ˆç©ºé—´ï¼Œå°±åº”è¯¥å°½é‡é¿å…å­˜å‚¨å®¹é‡å¤§æˆ–è€…å£°æ˜å‘¨æœŸé•¿çš„æ•°æ®ã€‚

æ‰€ä»¥å †(Heap)å°±æœ‰å®ƒå­˜åœ¨çš„åœºæ™¯äº†ï¼Œå†…å­˜ç©ºé—´å¤§ï¼Œæ•°æ®å­˜åœ¨æ—¶é—´é•¿ ï¼ˆä¾èµ–äºä¸åŒçš„å†…å­˜é‡Šæ”¾ç­–ç•¥ï¼‰ï¼Œé€šè¿‡åœ°å€å¼•ç”¨ï¼Œä¹Ÿç›¸å¯¹æ¾æ•£ã€‚

### å †æ ˆçš„æ–¹å‘
å¦ä¸€ä¸ªç»å¸¸è®©äººå›°æƒ‘çš„ç‚¹åœ¨äºï¼Œå¸¸è§çš„æ–‡ç« ä¸­ï¼Œå †æ ˆç»å¸¸æ˜¯ä»¥ç›¸åçš„æ–¹å‘è¿›è¡Œå†…å­˜åˆ†é…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒStackç”±é«˜åœ°å€å‘ä½åœ°å€ç´¢å–ç©ºé—´ï¼ŒHeapåˆ™ç›¸åä»ä½å‘é«˜ã€‚ä½†æ˜¯ä¹Ÿæœ‰å¾ˆåˆ«å¤„æ˜¯Stackè‡ªä¸Šè€Œä¸‹ï¼ŒHeapç›¸åã€‚æ‰€ä»¥æ˜¯ä¸æ˜¯å†™é”™äº†ï¼Ÿåˆ°åº•å“ªç§æ‰æ˜¯æ­£ç¡®çš„åˆ†é…æ–¹æ¡ˆã€‚å…¶å®æ ¹æ®ç³»ç»Ÿæ¶æ„çš„ä¸åŒï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯å­˜åœ¨çš„ã€‚åªæ˜¯é¡ºåºçš„é¢ å€’ğŸ™ƒï¸ï¼Œæ²¡æœ‰å…¶å®ƒä¸åŒã€‚
![ ]( /assets/img/2018/1094457-20170112144012306-484648661.png )

è‡³äºä¸ºä»€ä¹ˆä¼šæ”¾åœ¨ä¸€èµ·ï¼Œå¤§æ¦‚æ˜¯åœ¨ä¸Šå¤æ—¶æœŸï¼Œå†…å­˜æœ‰é™çš„æƒ…å†µä¸‹ï¼ŒHeapå’ŒStackèƒ½å…±äº«ä¸€æ®µè¿ç»­ç©ºé—´ï¼Œæ ¹æ®è‡ªèº«æƒ…å†µï¼Œåœ¨ä¿è¯å®‰å…¨çš„æƒ…å†µä¸‹ï¼Œå‘å¯¹æ–¹éœ¸å ä¸€äº›é¢†åœ°ã€‚ä»è€Œæ›´å¥½çš„åˆ©ç”¨å†…å­˜ã€‚
åœ¨ç°ä»Šçš„æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶ä¸Šï¼Œå°±å¾ˆå°‘å‡ºç°è¿™ä¹ˆç´§ä¿çš„æƒ…å†µï¼Œè€Œä¸”Stackå’ŒHeapä¹Ÿä¸ä¼šåœ¨è¿ç»­çš„ç‰©ç†å†…å­˜ä¸­ã€‚Heapå’ŒStackè¿ç»­çš„æƒ…å†µæ›´å¤šæ˜¯å‡ºç°åœ¨ä»¥è™šæ‹Ÿå†…å­˜ä¸­ï¼Œæ¥è¡¨ç¤ºç¨‹åºçš„ç»“æ„ã€‚

### å‚è€ƒèµ„æ–™
- [objective c - Are NSStrings stored on the heap or on the stack and what is a good way to initialize one - Stack Overflow](https://stackoverflow.com/questions/7376261/are-nsstrings-stored-on-the-heap-or-on-the-stack-and-what-is-a-good-way-to-initi)
- [iphone - Why do weak NSString properties not get released in iOS? - Stack Overflow](https://stackoverflow.com/questions/11107729/why-do-weak-nsstring-properties-not-get-released-in-ios)
- [objective c - Why isnâ€™t my weak reference cleared right after the strong ones are gone? - Stack Overflow](https://stackoverflow.com/questions/15266367/why-isn-t-my-weak-reference-cleared-right-after-the-strong-ones-are-gone)
- [iOSä¸­ï¼Œå¯¹è±¡é‡Šæ”¾æœºåˆ¶ä»¥åŠ__weakã€__unsafe_unretainedçš„ä¸€äº›é—®é¢˜ - RainæŠ€æœ¯æ”¯æŒ - å¼€æºä¸­å›½](https://my.oschina.net/rainwz/blog/1835660)
- [c - How to find whether a given address is in heap or in stack - Stack Overflow](https://stackoverflow.com/questions/33798216/how-to-find-whether-a-given-address-is-in-heap-or-in-stack)
- [memory management - What and where are the stack and heap? - Stack Overflow](https://stackoverflow.com/questions/79923/what-and-where-are-the-stack-and-heap)
- [å°†stackç¿»è¯‘æˆ"å †æ ˆ"å®åœ¨æ˜¯è¯¯äººå­å¼Ÿ - veli - åšå®¢å›­](https://www.cnblogs.com/idorax/p/6277906.html)
- [Why does the stack address grow towards decreasing memory addresses? - Stack Overflow](https://stackoverflow.com/questions/4560720/why-does-the-stack-address-grow-towards-decreasing-memory-addresses)
- [1. Why size of stack memory is fixed? - Stack Overflow](https://stackoverflow.com/questions/38727205/1-why-size-of-stack-memory-is-fixed)
